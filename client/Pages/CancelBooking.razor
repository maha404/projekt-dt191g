@page "/avboka"
@inject HttpClient http
@using Newtonsoft.Json;
@using System.Text;

<h2>Avboka</h2>

<div>
    <Breadcrumb style="--bs-breadcrumb-divider: '>';" Items="NavItems1"></Breadcrumb>
</div>

<input type="number" @bind="bookingId" placeholder="bokningsnummer">
<input type="text" @bind="CustomerName">
<input type="text" @bind="CustomerPhone">
<button @onclick="Cancel">Avboka</button>
<br>
<p>@ErrorMessage</p>
<p>@SuccessMessage</p>

@code {

    private int bookingId;
    private string CustomerName;
    private string CustomerPhone;
    private string ErrorMessage;
    private string SuccessMessage;
    private BookingModel model = new BookingModel();
    private List<BreadcrumbItem> NavItems1 { get; set; }

    protected override async Task OnInitializedAsync()
    {
        NavItems1 = new List<BreadcrumbItem>
        {
            new BreadcrumbItem{ Text = "Startsidan", Href ="/" },
            new BreadcrumbItem{ Text = "Avboka", IsCurrentPage = true }
        };
    }
    private async Task Cancel()
    {
        try 
        {
            model.Id = bookingId;
            model.Name = CustomerName;
            model.PhoneNumber = CustomerPhone;

            var jsonContent = new StringContent(JsonConvert.SerializeObject(model), Encoding.UTF8, "application/json");

            var request = new HttpRequestMessage(HttpMethod.Delete, $"http://localhost:5244/api/booking/{bookingId}")
            {
                Content = jsonContent
            };

            var response = await http.SendAsync(request);

            if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ErrorMessage = "Bokningsnumret är inkorrekt";
            }
            else if (!response.IsSuccessStatusCode)
            {
                ErrorMessage = "Vänligen dubbelkolla uppgifterna";
            }
            else
            {
                SuccessMessage = "Bokning avbokad framgångsrikt.";
                ErrorMessage = "";
            }
        }
        catch (Exception ex)
        {
            // Handle general exceptions
            Console.WriteLine($"Fel vid avbokning: {ex.Message}");
        }
    }

    public class BookingModel
    {
        public int Id { get; set; }
        public int TreatmentId { get; set; }
        public DateTime DateTime { get; set; }
        public string Name { get; set; }
        public string PhoneNumber { get; set; }
        public bool Status { get; set; } = false;
    }
}
